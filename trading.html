<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø§Ù„ØªØ¯Ø§ÙˆÙ„ - BingX</title>
  <link rel="stylesheet" href="styles.css" />
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h1>Ø§Ù„ØªØ¯Ø§ÙˆÙ„</h1>
      <a class="action-button small" href="index.html">ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø©</a>
    </div>

    <div class="card">
      <label>Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ù„Ø©</label>
      <select id="crypto-select">
        <option value="BTC">Bitcoin (BTC)</option>
        <option value="ETH">Ethereum (ETH)</option>
        <option value="BNB">Binance Coin (BNB)</option>
        <option value="SOL">Solana (SOL)</option>
        <option value="USDT">Tether (USDT)</option>
      </select>

      <div id="market-info" class="market-row">
        <div class="market-card">
          <p>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
          <h3 id="price">--</h3>
        </div>
        <div class="market-card">
          <p>ØªØºÙŠØ± 24Ø³</p>
          <h3 id="change">--</h3>
        </div>
        <div class="market-card">
          <p>SMA(14)</p>
          <h3 id="sma">--</h3>
        </div>
        <div class="market-card">
          <p>RSI(14)</p>
          <h3 id="rsi">--</h3>
        </div>
      </div>

      <canvas id="priceChart" height="160"></canvas>

      <div class="trade-box">
        <input id="trade-amount" type="number" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„ØªØ¯Ø§ÙˆÙ„ (USDT)" />
        <button class="action-button" onclick="executeTrade()">Ø´Ø±Ø§Ø¡/ØªØ¯Ø§ÙˆÙ„</button>
      </div>
    </div>
  </div>

  <script src="script.js"></script>
  <script>
    // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØµÙØ­Ø©: ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø«Ù… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙˆÙ‚
    document.addEventListener('DOMContentLoaded', async () => {
      ensureLoggedInOrRedirect();
      const select = document.getElementById('crypto-select');
      select.addEventListener('change', () => loadMarketFor(select.value));
      await loadMarketFor(select.value);
    });

    // Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø±Ù…ÙˆØ² Ù„Ø£Ø³Ù…Ø§Ø¡ CoinGecko
    const COIN_MAP = {
      BTC: 'bitcoin',
      ETH: 'ethereum',
      BNB: 'binancecoin',
      SOL: 'solana',
      USDT: 'tether'
    };

    let priceChart = null;

    async function loadMarketFor(symbol) {
      const id = COIN_MAP[symbol];
      if (!id) return;
      // Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØªØºÙŠØ± 24 Ø³Ø§Ø¹Ø©
      try {
        // Simple price (current + 24h change)
        const sp = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${id}&vs_currencies=usd&include_24hr_change=true`).then(r=>r.json());
        const info = sp[id];
        const price = info?.usd ?? '--';
        const change = info?.usd_24h_change ?? 0;
        document.getElementById('price').innerText = price === '--' ? '--' : `$${price.toLocaleString(undefined, {maximumFractionDigits:2})}`;
        document.getElementById('change').innerText = `${change === '--' ? '--' : change.toFixed(2) + '%'}`;
      } catch (e) {
        console.warn('price fetch error', e);
      }

      // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³Ù… (7 Ø£ÙŠØ§Ù…ØŒ Ù†Ù‚Ø§Ø· Ø³Ø§Ø¹ÙŠØ©) Ù„Ø¨Ù†Ø§Ø¡ Ù…Ø¤Ø´Ø± Ùˆ Ø§Ù„Ø±Ø³Ù…
      try {
        const res = await fetch(`https://api.coingecko.com/api/v3/coins/${id}/market_chart?vs_currency=usd&days=7&interval=hourly`);
        const json = await res.json();
        const prices = (json.prices || []).map(p => ({ t: new Date(p[0]), v: p[1] }));
        const labels = prices.map(p => p.t.toLocaleString());
        const data = prices.map(p => p.v);

        // Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ (line)
        const ctx = document.getElementById('priceChart').getContext('2d');
        if (priceChart) priceChart.destroy();
        priceChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: `${symbol} Price (USD)`,
              data,
              borderWidth: 1.5,
              tension: 0.18,
              pointRadius: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { display: false },
              y: { ticks: { callback: v => `$${v}` } }
            }
          }
        });

        // Ø­Ø³Ø§Ø¨ SMA Ùˆ RSI (14)
        const sma = calculateSMA(data, 14);
        const rsi = calculateRSI(data, 14);
        document.getElementById('sma').innerText = isNaN(sma) ? '--' : `$${sma.toFixed(2)}`;
        document.getElementById('rsi').innerText = isNaN(rsi) ? '--' : rsi.toFixed(2);

      } catch (e) {
        console.error('market chart error', e);
      }
    }

    // ØªÙ†ÙÙŠØ° Ø¹Ù…Ù„ÙŠØ© ØªØ¯Ø§ÙˆÙ„ Ø¨Ø³ÙŠØ·Ø© (ØªØ®ÙÙŠØ¶ Ø§Ù„Ø±ØµÙŠØ¯)
    async function executeTrade() {
      const symbol = document.getElementById('crypto-select').value;
      const amount = parseFloat(document.getElementById('trade-amount').value);
      if (isNaN(amount) || amount <= 0) { alert('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„ØºØ§Ù‹ ØµØ­ÙŠØ­Ø§Ù‹'); return; }
      const ok = await tryConsumeBalance(amount);
      if (!ok) { alert('Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙ'); return; }
      alert(`âœ… ØªÙ… ØªÙ†ÙÙŠØ° ØµÙÙ‚Ø© ${symbol} Ø¨Ù‚ÙŠÙ…Ø© ${amount} USDT`);
      updateBalanceOnPage();
    }

    // Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª
    function calculateSMA(values, period) {
      if (!values || values.length < period) return NaN;
      const slice = values.slice(-period);
      const sum = slice.reduce((s, v) => s + v, 0);
      return sum / period;
    }

    function calculateRSI(values, period = 14) {
      if (!values || values.length <= period) return NaN;
      // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØºÙŠØ±Ø§Øª
      const gains = [], losses = [];
      for (let i = values.length - period; i < values.length; i++) {
        const change = values[i] - values[i-1];
        if (change >= 0) { gains.push(change); losses.push(0); }
        else { gains.push(0); losses.push(Math.abs(change)); }
      }
      const avgGain = gains.reduce((a,b)=>a+b,0)/period;
      const avgLoss = losses.reduce((a,b)=>a+b,0)/period;
      if (avgLoss === 0) return 100;
      const rs = avgGain / avgLoss;
      return 100 - (100 / (1 + rs));
    }
  </script>
</body>
</html>
